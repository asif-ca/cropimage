/** ---------------------------------------------------------------------------
	*											CropImage Plugin with JQuery
	* ---------------------------------------------------------------------------
	* Version: 1.0.0
	* Author: Fabrice K.E.M
	* Created: 10/06/2018
	* Updated: 26/11/2022
	* Repository: https://github.com/fabrice8/cropimage
	*/
!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&module.exports?module.exports=t(require("jquery")):t(jQuery)}((function(t){"use strict";var i={dark:"rgba(20, 20, 20, .6)",light:"rgba(250, 250, 250, .6)"},e=!1,o=!1;if(void 0===t||!t.hasOwnProperty("fn"))throw new Error("CropImage requires jQuery");function h(i,h,n){var a,d={width:h.minWidth,height:h.minHeight};/x/.test(h.imgFormat)?(a=h.imgFormat.split("x"),d.width=Number(a[0]),d.height=Number(a[1]),e=!0,o=!1,!1,t(".R-container [data-action]").hide()):/[1-9]\/[1-9]/.test(h.imgFormat)?(a=h.imgFormat.split("/"),d.width?d.height=d.width*(Number(a[1])/Number(a[0])):d.height&&(d.width=d.height*Number(a[0])/Number(a[1])),e=!1,o=!0,!1,t(".R-container [data-action]").show(),t(".R-container [class^=R-side-]").hide()):(d.width=d.width||10,d.height=d.height||10,e=!1,o=!1,!0,t(".R-container [data-action]").show()),i.width>=d.width&&i.height>=d.height?n({width:i.width,height:i.height,minWidth:d.width,minHeight:d.height,ratio:Number(d.width)/Number(d.height)}):t(".R-container").html('<div class="R-error">This image is smaller than '+d.width+"x"+d.height+"</div>")}function n(n,a){var d,r=t.extend({image:!1,imgFormat:"auto",minWidth:0,minHeight:0,device:"all",circleCrop:!1,zoomable:!0,zoomMax:2,inBoundGrid:!0,outBoundColor:"dark",btnDoneAttr:".R-container .R-btn-done"},n);t(this).html(function(t){return`<div class="R-container">\n\t\t\t\t\t\t\t<div class="R-cover"></div>\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t<div class="R-adapter">\n\t\t\t\t\t\t\t\t<canvas class="statCanvas"></canvas>\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t<div class="R-cropper ${t.circleCrop?"circle":""}">\n\t\t\t\t\t\t\t\t\t<canvas class="dynaCanvas"></canvas>\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t${t.inBoundGrid?'<div class="R-grid">\n\t\t\t\t\t\t\t\t\t\t\t<div class="R-col-1"></div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="R-col-2"></div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="R-col-3"></div>\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t<div class="R-raw-1"></div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="R-raw-2"></div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="R-raw-3"></div>\n\t\t\t\t\t\t\t\t\t\t</div>':""}\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t<div class="R-corner-lt" data-action="lt-crop"></div>\n\t\t\t\t\t\t\t\t\t<div class="R-corner-rt" data-action="rt-crop"></div>\n\t\t\t\t\t\t\t\t\t<div class="R-corner-rb" data-action="rb-crop"></div>\n\t\t\t\t\t\t\t\t\t<div class="R-corner-lb" data-action="lb-crop"></div>\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t<div class="R-side-left" data-action="l-crop"></div>\n\t\t\t\t\t\t\t\t\t<div class="R-side-top" data-action="t-crop"></div>\n\t\t\t\t\t\t\t\t\t<div class="R-side-right" data-action="r-crop"></div>\n\t\t\t\t\t\t\t\t\t<div class="R-side-bottom" data-action="b-crop"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>`}(r));var s=new Image,g=(t(this),t(".R-container")),c=t(".R-adapter"),p=t(".R-cropper"),l=t(".R-cover"),w=t('[class^="R-side-"], [class^="R-corner-"]');function m(h){var n=document.querySelector(".statCanvas"),d=document.querySelector(".dynaCanvas"),m=n.getContext("2d"),f=d.getContext("2d");f.imageSmoothingEnabled=!0,f.imageSmoothingQuality="high",n.width=g.width(),n.height=g.height(),function(t,i,e){var o=t.width,h=t.height,n=0,a=0;t.width>=t.height&&t.width>i.width()?(h*=i.width()/o,o=i.width(),n=(i.height()-h)/2):(o*=i.height()/h,h=i.height(),a=(i.width()-o)/2),e({width:o,height:h,left:a,top:n,HzImage:t.width!=t.height?t.width>t.height:null})}(h,g,(function(g){l.css({left:g.left+"px",top:g.top+"px",right:g.left+"px",bottom:g.top+"px",background:i[i.hasOwnProperty(r.outBoundColor)?r.outBoundColor:"dark"]}),function(t,i,e){var o,h,n=i.width,a=i.height;1!=t.ratio?t.ratio<1?(o=n<a?n/a>t.minWidth/t.minHeight?t.minWidth*a/t.minHeight:n:t.minWidth<t.minHeight?t.minWidth*a/t.minHeight:n,h=n<a?n/a>t.minWidth/t.minHeight?a:t.minHeight*n/t.minWidth:t.minWidth<t.minHeight?a:n*(t.minHeight/a)):(o=n<a?n:n/a>t.minWidth/t.minHeight?t.minWidth*a/t.minHeight:n,h=n<a?t.minHeight*n/t.minWidth:n/a>t.minWidth/t.minHeight?a:n*(t.minHeight/a)):o=h=n<a?n:a,e({width:o,height:h,left:i.HzImage?(n-o)/2:0,top:i.HzImage?0:(a-h)/2})}(h,g,(function(i){p.css({width:d.width=i.width-4,height:d.height=i.height-4,left:i.left+"px",top:i.top+"px"});var u=g.width-d.width,v=g.height-d.height,x=0+g.width,b=0+g.height,R=h.minWidth||p.width()/2,I=h.minHeight||p.height()/2,y=!1,H={width:g.width,height:g.height,left:0,top:0},C={},W={},k=!0,E=0,X=1;function Y(t,i,e){var o=(e?t.originalEvent.touches[0].clientX:t.pageX)-i.x,h=(e?t.originalEvent.touches[0].clientY:t.pageY)-i.y,a=h>=0&&h<=v-4;o>=0&&o<=u-4?p.css("left",o+"px"):o=p.position().left,a?p.css("top",h+"px"):h=p.position().top,X>1&&(m.clearRect(0,0,H.width,H.height),i.ox=Math.floor(t.pageX-l.offset().left),i.oy=Math.floor(t.pageY-l.offset().top),m.drawImage(s,-i.ox*E,-i.oy*E,H.width,H.height)),f.drawImage(n,o+2,h+2,p.width(),p.height(),0,0,p.width(),p.height())}function z(t,i,e){var a,r,s=(e?t.originalEvent.touches[0].pageX:t.pageX)-p.offset().left,l=(e?t.originalEvent.touches[0].pageY:t.pageY)-p.offset().top,w=(e?t.originalEvent.touches[0].clientX:t.clientX)-c.offset().left,m=(e?t.originalEvent.touches[0].clientY:t.clientY)-c.offset().top;switch(i.t.data("action")){case"l-crop":a=p.width()-s,0<=w&&a>R&&(p.css({width:a+"px",left:w+"px"}),d.width=a,f.drawImage(n,w+2,p.position().top+2,a,p.height(),0,0,a,p.height()));break;case"r-crop":a=s,x-4>=w&&a>R&&(p.css("width",a+"px"),d.width=a,f.drawImage(n,p.position().left+2,p.position().top+2,a,p.height(),0,0,a,p.height()));break;case"t-crop":r=p.height()-l,0<=m&&r>I&&(p.css({height:r+"px",top:m+"px"}),d.height=r,f.drawImage(n,p.position().left+2,m,p.width()+2,r,0,0,p.width(),r));break;case"b-crop":r=l,b-4>=m&&r>I&&(p.css("height",r+"px"),d.height=r,f.drawImage(n,p.position().left+2,p.position().top+2,p.width(),r,0,0,p.width(),r));break;case"lt-crop":a=p.width()-s,r=p.height()-l,o?0<=w&&a>R&&(r=a/h.ratio,0<=(m=i.topHeight-r)&&m<=g.height-r-4&&r>I&&(p.css({width:a+"px",height:r+"px",left:w+"px",top:m+"px"}),d.width=a,d.height=r,f.drawImage(n,w+2,m+2,a,r,0,0,a,r))):(0<=w&&a>R&&(p.css({width:a+"px",left:w+"px"}),d.width=a,f.drawImage(n,w+2,p.position().top+2,a,p.height(),0,0,a,p.height())),0<=m&&r>I&&(p.css({height:r+"px",top:m+"px"}),d.height=r,f.drawImage(n,p.position().left+2,m+2,p.width(),r,0,0,p.width(),r)));break;case"lb-crop":a=p.width()-s,r=l,o?0<=w&&a>R&&(r=a/h.ratio,b-4>=m&&r>I&&r<g.height-p.position().top-4&&(p.css({width:a+"px",height:r+"px",left:w+"px"}),d.width=a,d.height=r,f.drawImage(n,w+2,p.position().top+2,a,r,0,0,a,r))):(0<=w&&a>R&&(p.css({width:a+"px",left:w+"px"}),d.width=a,f.drawImage(n,w+2,p.position().top+2,a,p.height(),0,0,a,p.height())),b-4>=m&&r>I&&(p.css("height",r+"px"),d.height=r,f.drawImage(n,p.position().left+2,p.position().top+2,p.width(),r,0,0,p.width(),r)));break;case"rt-crop":a=s,r=p.height()-l,o?x-4>=w&&a>R&&(r=a/h.ratio,0<=(m=i.topHeight-r)&&r>I&&(p.css({width:a+"px",height:r+"px",top:m+"px"}),d.width=a,d.height=r,f.drawImage(n,p.position().left+2,m+2,a,r,0,0,a,r)),i.lastLeft=w):(x-4>=w&&a>R&&(p.css("width",a+"px"),d.width=a,f.drawImage(n,p.position().left+2,p.position().top+2,a,p.height(),0,0,a,p.height())),0<=m&&r>I&&(p.css({height:r+"px",top:m+"px"}),d.height=r,f.drawImage(n,p.position().left+2,m+2,p.width(),r,0,0,p.width(),r)));break;case"rb-crop":a=s,r=l,o?x-4>=w&&a>R&&(r=a/h.ratio,b-4>=m&&r>I&&r<g.height-p.position().top-4&&(p.css({width:a+"px",height:r+"px"}),d.width=a,d.height=r,f.drawImage(n,p.position().left+2,p.position().top+2,a,r,0,0,a,r))):(x-4>=w&&a>R&&(p.css("width",a+"px"),d.width=a,f.drawImage(n,p.position().left+2,p.position().top+2,a,p.height(),0,0,a,p.height())),b-4>=m&&r>I&&(p.css("height",r+"px"),d.height=r,f.drawImage(n,p.position().left+2,p.position().top+2,p.width(),r,0,0,p.width(),r)))}}function N(){y=!1,C={},W={}}m.drawImage(s,0,0,g.width,g.height),c.css({left:g.left,top:g.top,width:g.width,height:g.height}),f.drawImage(n,i.left+2,i.top+2,i.width,i.height,0,0,i.width,i.height),p.mousedown((function(t){y||(C.t=p,C.x=t.pageX-p.position().left,C.y=t.pageY-p.position().top),u=g.width-p.width(),v=g.height-p.height()})).dblclick((function(t){r.zoomable&&(1==X&&(k=!0),X>r.zoomMax-.5&&(k=!1),C.ox=Math.floor(t.pageX-l.offset().left),C.oy=Math.floor(t.pageY-l.offset().top),function(t){m.clearRect(0,0,H.width,H.height),t&&X<r.zoomMax?X++:X>1&&X--;H.width=g.width*X,H.height=g.height*X,E=X-(X>1?X/2:0),H.left=X>1?-C.ox*E:0,H.top=X>1?-C.oy*E:0,m.drawImage(s,H.left,H.top,H.width,H.height),f.drawImage(n,p.position().left+2,p.position().top+2,p.width(),p.height(),0,0,p.width(),p.height())}(k))})).touchstart((function(t){y||(C.t=p,C.x=t.originalEvent.touches[0].clientX-p.position().left,C.y=t.originalEvent.touches[0].clientY-p.position().top),u=g.width-p.width(),v=g.height-p.height()})),w.mousedown((function(i){y=!0,W.t=t(this),W.topHeight=p.position().top+p.height()})),t(document).mouseup((function(){N()})).mousemove((function(t){t.preventDefault(),!e&&W.t&&z(t,W)})).touchend((function(){N()})),c.mousemove((function(t){t.preventDefault(),C.t&&Y(t,C)})).touchmove((function(t){t.preventDefault(),C.t?Y(t,C,!0):W.t&&(W.x||W.y)&&z(t,W,!0)})),t(r.btnDoneAttr).click((function(){"function"==typeof a&&a(d.toDataURL("image/jpeg"))}))}))}))}r.image?d="string"!=typeof r.image?window.URL.createObjectURL(r.image):r.image:g.html('<div class="R-error">Configuration Error: Set the image URL or blob image file as options.image </div>'),"file:"==window.location.protocol?console.warn("[CropImage] - Exporting cropped image might not work because of <file://> protocol"):s.crossOrigin="*",s.onerror=function(){console.error("Could not load image at "+d)},s.onload=function(){h(s,r,m),t(window).on("resize",(function(){h(s,r,m)}))},s.src=d}return t.fn.cropimage=n,t.fn.extend({touchend:function(t){return t?this.bind("touchend",t):this.trigger("touchend")},touchstart:function(t){return t?this.bind("touchstart",t):this.trigger("touchstart")},touchmove:function(t){return t?this.bind("touchmove",t):this.trigger("touchmove")}}),n}));